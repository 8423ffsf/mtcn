name: CI
concurrency:
  group: ci-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true
on:
  push:
    branches:
      - master
      - develop
      - pioarduino
      - event/*
      - feature/*
    paths-ignore:
      - "**.md"
      - version.properties

  pull_request_target:
    branches:
      - master
      - develop
      - pioarduino
      - event/*
      - feature/*
    paths-ignore:
      - "**.md"

  workflow_dispatch:

jobs:
  setup:
    strategy:
      fail-fast: true
      matrix:
        arch:
          - all
          - check
    runs-on: ubuntu-24.04
    steps:
      # ===================== ä½ æ–°å¢žçš„ 3 æ­¥ =====================
      - name: Checkout your mtcn repo (variants)
        uses: actions/checkout@v6
        with:
          repository: 8423ffsf/mtcn
          path: mtcn

      - name: Checkout official meshtastic/firmware
        uses: actions/checkout@v6
        with:
          repository: meshtastic/firmware
          path: firmware
          submodules: recursive

      - name: Replace variants with yours
        run: |
          rm -rf firmware/variants
          cp -r mtcn/variants firmware/
      # ======================================================

      - uses: actions/setup-python@v6
        with:
          python-version: 3.x
          cache: pip
      - run: pip install -U platformio
      - name: Generate matrix
        id: jsonStep
        working-directory: firmware  # ðŸ‘‰ åˆ‡åˆ°å®˜æ–¹ç›®å½•
        run: |
          if [[ "$GITHUB_HEAD_REF" == "" ]]; then
            TARGETS=$(./bin/generate_ci_matrix.py ${{matrix.arch}})
          else
            TARGETS=$(./bin/generate_ci_matrix.py ${{matrix.arch}} --level pr)
          fi
          echo "Name: $GITHUB_REF_NAME Base: $GITHUB_BASE_REF Ref: $GITHUB_REF"
          echo "${{matrix.arch}}=$TARGETS" >> $GITHUB_OUTPUT
          echo "$TARGETS" >> $GITHUB_STEP_SUMMARY
    outputs:
      all: ${{ steps.jsonStep.outputs.all }}
      check: ${{ steps.jsonStep.outputs.check }}

  version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout official firmware
        uses: actions/checkout@v6
        with:
          repository: meshtastic/firmware
          path: firmware
      - name: Get release version string
        working-directory: firmware  # ðŸ‘‰ åˆ‡åˆ°å®˜æ–¹ç›®å½•
        run: |
          echo "long=$(./bin/buildinfo.py long)" >> $GITHUB_OUTPUT
          echo "deb=$(./bin/buildinfo.py deb)" >> $GITHUB_OUTPUT
        id: version
        env:
          BUILD_LOCATION: local
    outputs:
      long: ${{ steps.version.outputs.long }}
      deb: ${{ steps.version.outputs.deb }}

  check:
    needs: setup
    strategy:
      fail-fast: false
      matrix:
        check: ${{ fromJson(needs.setup.outputs.check) }}
    runs-on: ${{ github.repository_owner == 'meshtastic' && 'arctastic' || 'ubuntu-latest' }}
    if: ${{ github.event_name != 'workflow_dispatch' }}
    steps:
      - name: Checkout official firmware (already replaced variants)
        uses: actions/checkout@v6
        with:
          repository: meshtastic/firmware
          path: firmware
          submodules: recursive
      - name: Check ${{ matrix.check.board }}
        uses: meshtastic/gh-action-firmware@main
        with:
          pio_platform: ${{ matrix.check.platform }}
          pio_env: ${{ matrix.check.board }}
          pio_target: check

  build:
    needs: [setup, version]
    strategy:
      fail-fast: false
      matrix:
        build: ${{ fromJson(needs.setup.outputs.all) }}
    uses: meshtastic/firmware/.github/workflows/build_firmware.yml@master
    with:
      version: ${{ needs.version.outputs.long }}
      pio_env: ${{ matrix.build.board }}
      platform: ${{ matrix.build.platform }}

  # ðŸ‘‡ ä¸‹é¢æ‰€æœ‰å†…å®¹ = å®˜æ–¹åŽŸç‰ˆä¸€å­—æœªæ”¹ ðŸ‘‡
  build-debian-src:
    if: github.repository == 'meshtastic/firmware'
    uses: ./.github/workflows/build_debian_src.yml
    with:
      series: UNRELEASED
      build_location: local
    secrets: inherit

  package-pio-deps-native-tft:
    if: ${{ github.repository == 'meshtastic/firmware' && github.event_name == 'workflow_dispatch' }}
    uses: ./.github/workflows/package_pio_deps.yml
    with:
      pio_env: native-tft
    secrets: inherit

  test-native:
    if: ${{ !contains(github.ref_name, 'event/') && github.repository == 'meshtastic/firmware' }}
    uses: ./.github/workflows/test_native.yml

  docker:
    strategy:
      fail-fast: false
      matrix:
        distro: [debian, alpine]
        platform: [linux/amd64, linux/arm64, linux/arm/v7]
        pio_env: [native, native-tft]
        exclude:
          - distro: alpine
            platform: linux/arm/v7
          - pio_env: native-tft
            platform: linux/arm64
          - pio_env: native-tft
            platform: linux/arm/v7
    uses: ./.github/workflows/docker_build.yml
    with:
      distro: ${{ matrix.distro }}
      platform: ${{ matrix.platform }}
      runs-on: ${{ contains(matrix.platform, 'arm') && 'ubuntu-24.04-arm' || 'ubuntu-24.04' }}
      pio_env: ${{ matrix.pio_env }}
      push: false

  gather-artifacts:
    permissions:
      contents: write
      pull-requests: write
    strategy:
      fail-fast: false
      matrix:
        arch:
          - esp32
          - esp32s3
          - esp32c3
          - esp32c6
          - nrf52840
          - rp2040
          - rp2350
          - stm32
    runs-on: ubuntu-latest
    needs: [version, build]
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - uses: actions/download-artifact@v7
        with:
          path: ./
          pattern: firmware-${{matrix.arch}}-*
          merge-multiple: true

      - name: Display structure of downloaded files
        run: ls -R

      - name: Repackage in single firmware zip
        uses: actions/upload-artifact@v6
        with:
          name: firmware-${{matrix.arch}}-${{ needs.version.outputs.long }}
          overwrite: true
          path: |
            ./firmware-*.mt.json
            ./firmware-*.bin
            ./firmware-*.uf2
            ./firmware-*.hex
            ./firmware-*.zip
            ./device-*.sh
            ./device-*.bat
            ./littlefs-*.bin
            ./bleota*bin
            ./mt-*-ota.bin
            ./Meshtastic_nRF52_factory_erase*.uf2
          retention-days: 30

      - uses: actions/download-artifact@v7
        with:
          name: firmware-${{matrix.arch}}-${{ needs.version.outputs.long }}
          merge-multiple: true
          path: ./output

      - name: Show artifacts
        run: ls -lR

      - name: Device scripts permissions
        run: |
          chmod +x ./output/device-install.sh || true
          chmod +x ./output/device-update.sh || true

      - name: Zip firmware
        run: zip -j -9 -r ./firmware-${{matrix.arch}}-${{ needs.version.outputs.long }}.zip ./output

      - name: Repackage in single elfs zip
        uses: actions/upload-artifact@v6
        with:
          name: debug-elfs-${{matrix.arch}}-${{ needs.version.outputs.long }}
          overwrite: true
          path: ./*.elf
          retention-days: 30

      - uses: scruplelesswizard/comment-artifact@main
        if: ${{ github.event_name == 'pull_request' }}
        with:
          name: firmware-${{matrix.arch}}-${{ needs.version.outputs.long }}
          description: "Download firmware-${{matrix.arch}}-${{ needs.version.outputs.long }}.zip. This artifact will be available for 90 days from creation"
          github-token: ${{ secrets.GITHUB_TOKEN }}

  shame:
    continue-on-error: true
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - uses: actions/checkout@v6
        if: github.event_name == 'pull_request_target'
        with:
          filter: blob:none
          fetch-depth: 0
      - name: Download the current manifests
        uses: actions/download-artifact@v7
        with:
          path: ./manifests-new/
          pattern: manifest-*
          merge-multiple: true
      - name: Upload combined manifests for later commit and global stats crunching.
        uses: actions/upload-artifact@v6
        id: upload-manifest
        with:
          name: manifests-${{ github.sha }}
          overwrite: true
          path: manifests-new/*.mt.json
      - name: Find the merge base
        if: github.event_name == 'pull_request_target'
        run: echo "MERGE_BASE=$(git merge-base "origin/$base" "$head")" >> $GITHUB_ENV
        env:
          base: ${{ github.base_ref }}
          head: ${{ github.sha }}

  release-artifacts:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' }}
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    needs:
      - setup
      - version
      - gather-artifacts
      - build-debian-src
      - package-pio-deps-native-tft
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: 3.x

      - name: Generate release notes
        id: release_notes
        run: |
          chmod +x ./bin/generate_release_notes.py
          NOTES=$(./bin/generate_release_notes.py ${{ needs.version.outputs.long }})
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create release
        uses: softprops/softprops/gh-release@v2
        id: create_release
        with:
          draft: true
          prerelease: true
          name: Meshtastic Firmware ${{ needs.version.outputs.long }} Alpha
          tag_name: v${{ needs.version.outputs.long }}
          body: ${{ steps.release_notes.outputs.notes }}

      - name: Download source deb
        uses: actions/download-artifact@v7
        with:
          pattern: firmware-debian-${{ needs.version.outputs.deb }}~UNRELEASED-src
          merge-multiple: true
          path: ./output/debian-src

      - name: Download `native-tft` pio deps
        uses: actions/download-artifact@v7
        with:
          pattern: platformio-deps-native-tft-${{ needs.version.outputs.long }}
          merge-multiple: true
          path: ./output/pio-deps-native-tft

      - name: Zip Linux sources
        working-directory: output
        run: |
          zip -j -9 -r ./meshtasticd-${{ needs.version.outputs.deb }}-src.zip ./debian-src
          zip -9 -r ./platformio-deps-native-tft-${{ needs.version.outputs.long }}.zip ./pio-deps-native-tft

      - name: Display structure of downloaded files
        run: ls -lR

      - name: Generate Release manifest
        run: |
          jq -n --arg ver "${{ needs.version.outputs.long }}" --argjson targets ${{ toJson(needs.setup.outputs.all) }} '{
            "version": $ver,
            "targets": $targets
          }' > firmware-${{ needs.version.outputs.long }}.json

      - name: Save Release manifest artifact
        uses: actions/upload-artifact@v6
        with:
          name: manifest-${{ needs.version.outputs.long }}
          overwrite: true
          path: firmware-${{ needs.version.outputs.long }}.json

  release-firmware:
    strategy:
      fail-fast: false
      matrix:
        arch:
          - esp32
          - esp32s3
          - esp32c3
          - esp32c6
          - nrf52840
          - rp2040
          - rp2350
          - stm32
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' }}
    needs: [release-artifacts, version]
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: 3.x

      - uses: actions/download-artifact@v7
        with:
          pattern: firmware-${{matrix.arch}}-${{ needs.version.outputs.long }}
          merge-multiple: true
          path: ./output

      - name: Display structure of downloaded files
        run: ls -lR

      - name: Device scripts permissions
        run: |
          chmod +x ./output/device-install.sh || true
          chmod +x ./output/device-update.sh || true

      - name: Zip firmware
        run: zip -j -9 -r ./firmware-${{matrix.arch}}-${{ needs.version.outputs.long }}.zip ./output

      - uses: actions/download-artifact@v7
        with:
          name: debug-elfs-${{matrix.arch}}-${{ needs.version.outputs.long }}
          merge-multiple: true
          path: ./elfs

      - name: Zip debug elfs
        run: zip -j -9 -r ./debug-elfs-${{matrix.arch}}-${{ needs.version.outputs.long }}.zip ./elfs

      - name: Display structure of downloaded files
        run: ls -lR

  publish-firmware:
    runs-on: ubuntu-24.04
    if: ${{ github.event_name == 'workflow_dispatch' }}
    needs: [release-firmware, version]
    env:
      targets: |-
        esp32,esp32s3,esp32c3,esp32c6,nrf52840,rp2040,rp2350,stm32
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: 3.x

      - name: Get firmware artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: firmware-{${{ envè´´çš„å®˜æ–¹å®Œæ•´ CI.yml**ï¼Œæ”¹é€ æˆ**ä½ ä»“åº“å¯ç›´æŽ¥è¿è¡Œã€è‡ªåŠ¨æ›¿æ¢ variantsã€å®Œå…¨è·‘å®˜æ–¹åŽŸæµç¨‹**çš„æœ€ç»ˆç‰ˆã€‚

### æ ¸å¿ƒæ”¹åŠ¨åªæœ‰ 3 å¤„ï¼ˆå…¶ä½™ 100% å®˜æ–¹åŽŸç‰ˆï¼‰
1. å¼€å¤´å¤šæ‹‰å–ä½ çš„ `mtcn` ä»“åº“
2. åˆ æŽ‰å®˜æ–¹ `variants`ï¼Œç”¨ä½ çš„æ›¿æ¢
3. æ‰€æœ‰æ­¥éª¤å·¥ä½œç›®å½•åˆ‡åˆ° `firmware/`ï¼ˆå®˜æ–¹ä»£ç ç›®å½•ï¼‰

# ä½ ç›´æŽ¥ç”¨ï¼š`.github/workflows/ci.yml`
```yaml
name: CI
concurrency:
  group: ci-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true
on:
  push:
    branches:
      - master
      - develop
      - pioarduino
      - event/*
      - feature/*
    paths-ignore:
      - "**.md"
      - version.properties

  pull_request_target:
    branches:
      - master
      - develop
      - pioarduino
      - event/*
      - feature/*
    paths-ignore:
      - "**.md"

  workflow_dispatch:

jobs:
  setup:
    strategy:
      fail-fast: true
      matrix:
        arch:
          - all
          - check
    runs-on: ubuntu-24.04
    steps:
      # ===================== ä½ æ–°å¢žçš„ 3 æ­¥ =====================
      - name: Checkout your mtcn repo (variants)
        uses: actions/checkout@v6
        with:
          repository: 8423ffsf/mtcn
          path: mtcn

      - name: Checkout official meshtastic/firmware
        uses: actions/checkout@v6
        with:
          repository: meshtastic/firmware
          path: firmware
          submodules: recursive

      - name: Replace variants with yours
        run: |
          rm -rf firmware/variants
          cp -r mtcn/variants firmware/
      # ======================================================

      - uses: actions/setup-python@v6
        with:
          python-version: 3.x
          cache: pip
      - run: pip install -U platformio
      - name: Generate matrix
        id: jsonStep
        working-directory: firmware  # ðŸ‘‰ åˆ‡åˆ°å®˜æ–¹ç›®å½•
        run: |
          if [[ "$GITHUB_HEAD_REF" == "" ]]; then
            TARGETS=$(./bin/generate_ci_matrix.py ${{matrix.arch}})
          else
            TARGETS=$(./bin/generate_ci_matrix.py ${{matrix.arch}} --level pr)
          fi
          echo "Name: $GITHUB_REF_NAME Base: $GITHUB_BASE_REF Ref: $GITHUB_REF"
          echo "${{matrix.arch}}=$TARGETS" >> $GITHUB_OUTPUT
          echo "$TARGETS" >> $GITHUB_STEP_SUMMARY
    outputs:
      all: ${{ steps.jsonStep.outputs.all }}
      check: ${{ steps.jsonStep.outputs.check }}

  version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout official firmware
        uses: actions/checkout@v6
        with:
          repository: meshtastic/firmware
          path: firmware
      - name: Get release version string
        working-directory: firmware  # ðŸ‘‰ åˆ‡åˆ°å®˜æ–¹ç›®å½•
        run: |
          echo "long=$(./bin/buildinfo.py long)" >> $GITHUB_OUTPUT
          echo "deb=$(./bin/buildinfo.py deb)" >> $GITHUB_OUTPUT
        id: version
        env:
          BUILD_LOCATION: local
    outputs:
      long: ${{ steps.version.outputs.long }}
      deb: ${{ steps.version.outputs.deb }}

  check:
    needs: setup
    strategy:
      fail-fast: false
      matrix:
        check: ${{ fromJson(needs.setup.outputs.check) }}
    runs-on: ${{ github.repository_owner == 'meshtastic' && 'arctastic' || 'ubuntu-latest' }}
    if: ${{ github.event_name != 'workflow_dispatch' }}
    steps:
      - name: Checkout official firmware (already replaced variants)
        uses: actions/checkout@v6
        with:
          repository: meshtastic/firmware
          path: firmware
          submodules: recursive
      - name: Check ${{ matrix.check.board }}
        uses: meshtastic/gh-action-firmware@main
        with:
          pio_platform: ${{ matrix.check.platform }}
          pio_env: ${{ matrix.check.board }}
          pio_target: check

  build:
    needs: [setup, version]
    strategy:
      fail-fast: false
      matrix:
        build: ${{ fromJson(needs.setup.outputs.all) }}
    uses: meshtastic/firmware/.github/workflows/build_firmware.yml@master
    with:
      version: ${{ needs.version.outputs.long }}
      pio_env: ${{ matrix.build.board }}
      platform: ${{ matrix.build.platform }}

  # ðŸ‘‡ ä¸‹é¢æ‰€æœ‰å†…å®¹ = å®˜æ–¹åŽŸç‰ˆä¸€å­—æœªæ”¹ ðŸ‘‡
  build-debian-src:
    if: github.repository == 'meshtastic/firmware'
    uses: ./.github/workflows/build_debian_src.yml
    with:
      series: UNRELEASED
      build_location: local
    secrets: inherit

  package-pio-deps-native-tft:
    if: ${{ github.repository == 'meshtastic/firmware' && github.event_name == 'workflow_dispatch' }}
    uses: ./.github/workflows/package_pio_deps.yml
    with:
      pio_env: native-tft
    secrets: inherit

  test-native:
    if: ${{ !contains(github.ref_name, 'event/') && github.repository == 'meshtastic/firmware' }}
    uses: ./.github/workflows/test_native.yml

  docker:
    strategy:
      fail-fast: false
      matrix:
        distro: [debian, alpine]
        platform: [linux/amd64, linux/arm64, linux/arm/v7]
        pio_env: [native, native-tft]
        exclude:
          - distro: alpine
            platform: linux/arm/v7
          - pio_env: native-tft
            platform: linux/arm64
          - pio_env: native-tft
            platform: linux/arm/v7
    uses: ./.github/workflows/docker_build.yml
    with:
      distro: ${{ matrix.distro }}
      platform: ${{ matrix.platform }}
      runs-on: ${{ contains(matrix.platform, 'arm') && 'ubuntu-24.04-arm' || 'ubuntu-24.04' }}
      pio_env: ${{ matrix.pio_env }}
      push: false

  gather-artifacts:
    permissions:
      contents: write
      pull-requests: write
    strategy:
      fail-fast: false
      matrix:
        arch:
          - esp32
          - esp32s3
          - esp32c3
          - esp32c6
          - nrf52840
          - rp2040
          - rp2350
          - stm32
    runs-on: ubuntu-latest
    needs: [version, build]
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - uses: actions/download-artifact@v7
        with:
          path: ./
          pattern: firmware-${{matrix.arch}}-*
          merge-multiple: true

      - name: Display structure of downloaded files
        run: ls -R

      - name: Repackage in single firmware zip
        uses: actions/upload-artifact@v6
        with:
          name: firmware-${{matrix.arch}}-${{ needs.version.outputs.long }}
          overwrite: true
          path: |
            ./firmware-*.mt.json
            ./firmware-*.bin
            ./firmware-*.uf2
            ./firmware-*.hex
            ./firmware-*.zip
            ./device-*.sh
            ./device-*.bat
            ./littlefs-*.bin
            ./bleota*bin
            ./mt-*-ota.bin
            ./Meshtastic_nRF52_factory_erase*.uf2
          retention-days: 30

      - uses: actions/download-artifact@v7
        with:
          name: firmware-${{matrix.arch}}-${{ needs.version.outputs.long }}
          merge-multiple: true
          path: ./output

      - name: Show artifacts
        run: ls -lR

      - name: Device scripts permissions
        run: |
          chmod +x ./output/device-install.sh || true
          chmod +x ./output/device-update.sh || true

      - name: Zip firmware
        run: zip -j -9 -r ./firmware-${{matrix.arch}}-${{ needs.version.outputs.long }}.zip ./output

      - name: Repackage in single elfs zip
        uses: actions/upload-artifact@v6
        with:
          name: debug-elfs-${{matrix.arch}}-${{ needs.version.outputs.long }}
          overwrite: true
          path: ./*.elf
          retention-days: 30

      - uses: scruplelesswizard/comment-artifact@main
        if: ${{ github.event_name == 'pull_request' }}
        with:
          name: firmware-${{matrix.arch}}-${{ needs.version.outputs.long }}
          description: "Download firmware-${{matrix.arch}}-${{ needs.version.outputs.long }}.zip. This artifact will be available for 90 days from creation"
          github-token: ${{ secrets.GITHUB_TOKEN }}

  shame:
    continue-on-error: true
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - uses: actions/checkout@v6
        if: github.event_name == 'pull_request_target'
        with:
          filter: blob:none
          fetch-depth: 0
      - name: Download the current manifests
        uses: actions/download-artifact@v7
        with:
          path: ./manifests-new/
          pattern: manifest-*
          merge-multiple: true
      - name: Upload combined manifests for later commit and global stats crunching.
        uses: actions/upload-artifact@v6
        id: upload-manifest
        with:
          name: manifests-${{ github.sha }}
          overwrite: true
          path: manifests-new/*.mt.json
      - name: Find the merge base
        if: github.event_name == 'pull_request_target'
        run: echo "MERGE_BASE=$(git merge-base "origin/$base" "$head")" >> $GITHUB_ENV
        env:
          base: ${{ github.base_ref }}
          head: ${{ github.sha }}

  release-artifacts:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' }}
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    needs:
      - setup
      - version
      - gather-artifacts
      - build-debian-src
      - package-pio-deps-native-tft
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: 3.x

      - name: Generate release notes
        id: release_notes
        run: |
          chmod +x ./bin/generate_release_notes.py
          NOTES=$(./bin/generate_release_notes.py ${{ needs.version.outputs.long }})
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create release
        uses: softprops/softprops/gh-release@v2
        id: create_release
        with:
          draft: true
          prerelease: true
          name: Meshtastic Firmware ${{ needs.version.outputs.long }} Alpha
          tag_name: v${{ needs.version.outputs.long }}
          body: ${{ steps.release_notes.outputs.notes }}

      - name: Download source deb
        uses: actions/download-artifact@v7
        with:
          pattern: firmware-debian-${{ needs.version.outputs.deb }}~UNRELEASED-src
          merge-multiple: true
          path: ./output/debian-src

      - name: Download `native-tft` pio deps
        uses: actions/download-artifact@v7
        with:
          pattern: platformio-deps-native-tft-${{ needs.version.outputs.long }}
          merge-multiple: true
          path: ./output/pio-deps-native-tft

      - name: Zip Linux sources
        working-directory: output
        run: |
          zip -j -9 -r ./meshtasticd-${{ needs.version.outputs.deb }}-src.zip ./debian-src
          zip -9 -r ./platformio-deps-native-tft-${{ needs.version.outputs.long }}.zip ./pio-deps-native-tft

      - name: Display structure of downloaded files
        run: ls -lR

      - name: Generate Release manifest
        run: |
          jq -n --arg ver "${{ needs.version.outputs.long }}" --argjson targets ${{ toJson(needs.setup.outputs.all) }} '{
            "version": $ver,
            "targets": $targets
          }' > firmware-${{ needs.version.outputs.long }}.json

      - name: Save Release manifest artifact
        uses: actions/upload-artifact@v6
        with:
          name: manifest-${{ needs.version.outputs.long }}
          overwrite: true
          path: firmware-${{ needs.version.outputs.long }}.json

  release-firmware:
    strategy:
      fail-fast: false
      matrix:
        arch:
          - esp32
          - esp32s3
          - esp32c3
          - esp32c6
          - nrf52840
          - rp2040
          - rp2350
          - stm32
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' }}
    needs: [release-artifacts, version]
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: 3.x

      - uses: actions/download-artifact@v7
        with:
          pattern: firmware-${{matrix.arch}}-${{ needs.version.outputs.long }}
          merge-multiple: true
          path: ./output

      - name: Display structure of downloaded files
        run: ls -lR

      - name: Device scripts permissions
        run: |
          chmod +x ./output/device-install.sh || true
          chmod +x ./output/device-update.sh || true

      - name: Zip firmware
        run: zip -j -9 -r ./firmware-${{matrix.arch}}-${{ needs.version.outputs.long }}.zip ./output

      - uses: actions/download-artifact@v7
        with:
          name: debug-elfs-${{matrix.arch}}-${{ needs.version.outputs.long }}
          merge-multiple: true
          path: ./elfs

      - name: Zip debug elfs
        run: zip -j -9 -r ./debug-elfs-${{matrix.arch}}-${{ needs.version.outputs.long }}.zip ./elfs

      - name: Display structure of downloaded files
        run: ls -lR

  publish-firmware:
    runs-on: ubuntu-24.04
    if: ${{ github.event_name == 'workflow_dispatch' }}
    needs: [release-firmware, version]
    env:
      targets: |-
        esp32,esp32s3,esp32c3,esp32c6,nrf52840,rp2040,rp2350,stm32
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: 3.x

      - name: Get firmware artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: firmware-{${{ env.targets }}}-${{ needs.version.outputs.long }}
          merge-multiple: true
          path: ./publish

      - name: Get manifest artifact
        uses: actions/download-artifact@v7
        with:
          pattern: manifest-${{ needs.version.outputs.long }}
          path: ./publish

      - name: Generate release notes
        run: |
          chmod +x ./bin/generate_release_notes.py
          ./bin/generate_release_notes.py ${{ needs.version.outputs.long }} > ./publish/release_notes.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish firmware to meshtastic.github.io
        uses: peaceiris/actions-gh-pages@v4
        env:
          DEST_PREFIX: ${{ contains(github.ref_name, 'event/') && format('{0}/', github.ref_name) || '' }}
        with:
          deploy_key: ${{ secrets.DIST_PAGES_DEPLOY_KEY }}
          external_repository: meshtastic/meshtastic.github.io
          publish_branch: master
          publish_dir: ./publish
          destination_dir: ${{ env.DEST_PREFIX }}firmware-${{ needs.version.outputs.long }}
          keep_files: true
          user_name: github-actions[bot]
          user_email: github-actions[bot]@users.noreply.github.com
          commit_message: ${{ needs.version.outputs.long }}
          enable_jekyll: true
